<!--
    Copyright 2013 Aaron Curtis

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<!DOCTYPE html>
<html>
<head>
<link type="text/css" href="/media/js/openlayers/theme/default/scalebar-thin.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/media/js/openlayers/theme/default/style.css">
<link rel="stylesheet" type="text/css" href="/media/js/jqplot/jquery.jqplot.css" />
<link rel="stylesheet" type="text/css" href="/media/css/flightDetail.css">
<!-- FIXTHIS: host the css locally -->
<link rel="stylesheet" type="text/css" href="/media/css/timeline.css">
<script src="/media/js/jquery.min.js"></script>
<script src="/media/js/jqplot/jquery.jqplot.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.canvasOverlay.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.cursor.min.js"></script>
<script src="/media/js/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="/media/js/timeline.js"></script>
<script src="/media/js/openlayers/lib/Control/ScaleBar.js"></script>
{%if object.flightvideo_set.all %}
<script src="/media/js/swfobject.js"></script>
{% endif %}
<script>

// Setup map stuff
var WGS84 = new OpenLayers.Projection('EPSG:4326');
var MERCATOR = new OpenLayers.Projection('EPSG:900913');
var size = new OpenLayers.Size(21, 25);
var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
var apiKey = "An9cxmMkbbjVOwKKGr8hCIl6N6W30F7VChJdplng1Y12rOJIucGfYMoG5hk6lTct";


$(document).ready(function(){

// Pull all initial data from the DB
latLonsJSON={{object.latLonsJSON}}
plotData=[[{{object.battVltsDataFlot}}],[{{object.thrDataFlot}}]];
gpsTimestamps={{object.gpsTimestamps|safe}}
tlData = {{timeline_data|safe}}

// Setup the sensor data plot
try{
    min=plotData[0][0][0]
    max=plotData[0].slice(-1)[0][0]
    sensorPlot = $.jqplot('sensorPlot',  plotData, 
        {
            title:'{{object}}',
            axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickInterval:60},
                yaxis:{label:'Battery voltage, mV'},
                y2axis:{label:'Throttle PWM value'}},
            series:[{showMarker:false},{showMarker:false,yaxis:'y2axis'}],
            zoom: true,
            cursor: {
                show: true,
                showVerticalLine: true,
                zoom: true, 
            },
            canvasOverlay: {
                show:true,
                objects: [{
                    verticalLine: {
                        name: 'plotCursor',
                        x: min
                        }}]
            }
        }
    );
    // Workaround for bug described at https://bitbucket.org/cleonello/jqplot/issue/633/jqplotdatahighlight-does-not-work-for-line
    sensorPlot.series[0].highlightMouseOver = true;

    $("#sensorPlot").bind("jqplotDataMouseOver", function(event, srsInd, ptInd, hoveredDatum){
        if(hoveredDatum){
            //Add icon to map for time hoveredDatum[0] (not implemented yet)
        }
    });
}

catch(e){
}
// Draw videos
    {% for video in object.flightvideo_set.all %}

        var params = { allowScriptAccess: "always" };    
        var atts = { id: "vidPlayer{{video.id}}", class:"vidPlayer" };
        swfobject.embedSWF("{{video.url}}?enablejsapi=1&playerapiid=apiForVid{{video}}&version=3",
                            "vidPlayer{{video.id}}", "425", "356", "8", null, null, params, atts);
    {% endfor %}

// Draw map of flight path
function initMap() {
    // Bing's Road imagerySet
    var broad = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Road"
    });
    // Bing's Aerial imagerySet
    var baerial = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Aerial"
    });
    // Bing's AerialWithLabels imagerySet
    var bhybrid = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "AerialWithLabels",
        name: "Bing Aerial With Labels",
        // Ugly custom resolutions are for allowing client zoom. May be a better way.
        resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                      19567.87923828125, 9783.939619140625, 4891.9698095703125,
                      2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                      305.74811309814453, 152.87405654907226, 76.43702827453613,
                      38.218514137268066, 19.109257068634033, 9.554628534317017,
                      4.777314267158508, 2.388657133579254, 1.194328566789627,
                      0.5971642833948135, 0.25, 0.1, 0.05],
        serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                            19567.87923828125, 9783.939619140625,
                            4891.9698095703125, 2445.9849047851562,
                            1222.9924523925781, 611.4962261962891,
                            305.74811309814453, 152.87405654907226,
                            76.43702827453613, 38.218514137268066,
                            19.109257068634033, 9.554628534317017,
                            4.777314267158508, 2.388657133579254,
                            1.194328566789627, 0.5971642833948135],
        transitionEffect: 'resize'
    });

    flightMap = new OpenLayers.Map('map',{projection: MERCATOR,fractionalZoom: true});
    flightMap.addControl(new OpenLayers.Control.LayerSwitcher());
    flightMap.addControl(new OpenLayers.Control.ScaleLine());
    var flightPathFeaturesJSON = {
        "type": "FeatureCollection", 
        "features": [
        {
            "type": "Feature", 
            "geometry":
                {
                    "type": "LineString", 
                    "coordinates": latLonsJSON
                }, 
            
        },]
    };
    var geojson_format = new OpenLayers.Format.GeoJSON({
                    'internalProjection': MERCATOR,
                    'externalProjection': WGS84
                });
    vector_layer = new OpenLayers.Layer.Vector("Flight path",{ style:{strokeColor:"#FF0000",strokeWidth:1, projection: WGS84}});
    curPosLayer = new OpenLayers.Layer.Markers("Current position",{ style:{strokeColor:"#0000FF",strokeWidth:2, projection: WGS84}});
    flightPathFeatures=geojson_format.read(flightPathFeaturesJSON);
    vector_layer.addFeatures(flightPathFeatures);
    flightMap.addLayers([bhybrid, baerial, broad, vector_layer, curPosLayer]);
    flightMap.zoomToExtent(vector_layer.getDataExtent());
    };

initMap();

//Draw the timeline of flight events
function drawTimeline() {
    var options = {
        'width':  '100%',
        'height': '100%',
        'editable': false,
        'style': 'dot',
        'cluster': true,
        'showCustomTime':true
    };
    timeline = new links.Timeline(document.getElementById('timeline'))
    timeline.draw(tlData, options)
    timeline.setCustomTime(min)
    
    //Register an event to seek all widgets when the customtime bar is dragged
    links.events.addListener(timeline, 'timechange', onTimelineBarDragged)
};
drawTimeline();

// Widget control logic (mostly seeking)
function seekWidgetsTo(seekTime) {
    seekVideoTo(seekTime)
    seekPlotTo(seekTime)
    seekTimelineTo(seekTime)
    seekMapTo(seekTime)
}

getClosestIndex = function(a, x) {
    // This is a binary search, returning the index of the value just below the input x using the list a
    var low = 0, hi = a.length-1;
    while (hi - low > 1) {
        var mid = Math.round((low + hi)/2);
        if (a[mid] <= x) {
            low = mid;
        } else {
            hi = mid;
        }
    }
    if (a[low] == x) hi = low;
    console.log('closest value to ' + x + ' is ' + a[low] + 'at index' + low)
    return low   
}

seekMapTo=function(seekTime) {
    currentPos=latLonsJSON[getClosestIndex(gpsTimestamps,seekTime)]
    curPosMarker=new OpenLayers.Marker(new OpenLayers.LonLat(currentPos).transform(WGS84,MERCATOR), icon.clone())
    curPosLayer.clearMarkers();
    curPosLayer.addMarker(curPosMarker);
    curPosLayer.redraw();
}

function seekPlotTo(seekTime) {
    console.log(seekTime)
    plotCursor=sensorPlot.plugins.canvasOverlay.get('plotCursor')
    plotCursor.options.x=seekTime
    sensorPlot.plugins.canvasOverlay.draw(sensorPlot)
}

function seekVideoTo(seekTime) {
    {% for video in object.flightvideo_set.all %}
        vidStartTime={{video.startTimeJS}}
        //Youtube API takes seconds, JS timestamps are in ms, so divide by 1000
        vidSeekTime=(seekTime-vidStartTime)/1000
        vidPlayer{{video.id}}.seekTo(vidSeekTime)
    {% endfor %}
}

function seekTimelineTo(seekTime) {
    timeline.setCustomTime(seekTime)
}

function onTimelineBarDragged() {
    seekWidgetsTo(timeline.customTime)
}

{% for video in object.flightvideo_set.all %}
seekWidgetsToVidPos{{video.id}}=function() {    
    vidStartTime={{video.startTimeJS}}
    seekTime=vidPlayer{{video.id}}.getCurrentTime()*1000+vidStartTime
    console.log('trying to seek to time ' + parseInt(seekTime))
    seekPlotTo(seekTime)
    seekTimelineTo(seekTime)
    seekMapTo(seekTime)
}

onPlayer{{video.id}}StateChange = function (newstate) {
    // If we just started playing
    console.log("video state changed")
    if (newstate==1){
        console.log('started playing')
        vidSeekPoller=setInterval(seekWidgetsToVidPos{{video.id}}, 250)
    }
    else {
        console.log('stopped playing')
        clearInterval(vidSeekPoller)
    }
}

{% endfor %}

}); // end of jquery document.ready function

function onYouTubePlayerReady(playerId) {
{% for video in object.flightvideo_set.all %}
    
    vidPlayer{{video.id}} = document.getElementById("vidPlayer{{video.id}}");
    vidPlayer{{video.id}}.addEventListener("onStateChange","onPlayer{{video.id}}StateChange");
    console.log("added event listener")
{% endfor %}
}

function addVideoToTimeline() {
    //TODO make this handle multiple videos
    {% if flight.flightVideo_set.0 %}
        startime={{flight.flightVideo_set.0.startTime}}
        endtime={{flight.flightVideo_set.0.startTime}}+ytplayer.getDuration()
    {% endif %}
}

</script>

</head>
<body>
<div id="detailsContainer">
    <h1>Flight details</h1>
    {{object}}
    Mavlink messages by type
    <ul>
    {% for messageType in object.countMessagesByType %}
    <li>{{messageType.0}}: {{messageType.1}}</li>
    {% endfor %}
    </ul>
    Total mavlink messages: {{object.mavmessage_set.count}}

</div>
<div id="videoContainer">
    <h1>Video</h1>
    
    {% for video in object.flightvideo_set.all %}
        <div id="vidPlayer{{video.id}}"></div>
    {% endfor %}
    
</div>
<div id="plotContainer">
    <h1>Sensor data</h1>
        <div id="sensorPlot" style="width:600px;height:300px"></div>    
</div>
<div id="mapContainer">
    <h1>Map</h1>
    <div id="map"></div>
</div>
<div id="timelineContainer">
    <div id="timeline">Timeline loading...</div>
</div>


</div>
</body>
</html>