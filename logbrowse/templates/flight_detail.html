<!DOCTYPE html>
<html>
<head>
<link type="text/css" href="/media/js/openlayers/theme/default/scalebar-thin.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/media/js/openlayers/theme/default/style.css">
<link rel="stylesheet" type="text/css" href="/media/js/jqplot/jquery.jqplot.css" />
<link rel="stylesheet" type="text/css" href="/media/css/flightDetail.css">
<!-- FIXTHIS: host the css locally -->
<link rel="stylesheet" type="text/css" href="http://almende.github.com/chap-links-library/js/timeline/timeline.css">
<!-- FIXTHIS: probably don't need gmaps any more since using Bing -->
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script src="/media/js/jquery.min.js"></script>
<script src="/media/js/jqplot/jquery.jqplot.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.canvasOverlay.min.js"></script>
<script src="/media/js/jqplot/plugins/jqplot.cursor.min.js"></script>
<script src="/media/js/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="/media/js/timeline.js"></script>
<!-- FIXTHIS: host the scalebar addin locally -->
<script src="http://dev.openlayers.org/addins/scalebar/trunk/lib/OpenLayers/Control/ScaleBar.js"></script>
<script>
// FIXTHIS: most of these do not need to be global
var flightMap, layer, vector_layer, battVltsData,battThrData, hoveredItem, features, flightPathFeatures, limitedLayer, limitedFlightPathDecimal, gpsTimestamps, ytplayer, timeline, tlData;
ytplayer=5;
$(document).ready(function(){

gpsTimestamps={{object.gpsTimestamps}}
battThrData=[[{{object.battVltsDataFlot}}],[{{object.thrDataFlot}}]];
var apiKey = "An9cxmMkbbjVOwKKGr8hCIl6N6W30F7VChJdplng1Y12rOJIucGfYMoG5hk6lTct";
min=battThrData[0][0][0]
max=battThrData[0].slice(-1)[0][0]
battVltsData = $.jqplot('battVltsData',  battThrData, 
    {
        title:'{{object}}',
        axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickInterval:60},
            yaxis:{label:'Battery voltage, mV'},
            y2axis:{label:'Throttle PWM value'}},
        series:[{showMarker:false},{showMarker:false,yaxis:'y2axis'}],
        zoom: true,
        cursor: {
            show: true,
            showVerticalLine: true,
            zoom: true, 
        },
        canvasOverlay: {
            show:true,
            objects: [{
                verticalLine: {
                    name: 'plotCursor',
                    x: min
                    }}]
        }
    }
 );
//Workaround for bug described at https://bitbucket.org/cleonello/jqplot/issue/633/jqplotdatahighlight-does-not-work-for-line
battVltsData.series[0].highlightMouseOver = true;


$("#battVltsData").bind("jqplotDataMouseOver", function(event, srsInd, ptInd, data){
    if(data){
        hoveredItem=data
        decPos=(hoveredItem[0]-min)/(max-min)
        limitedFlightPathDecimal(decPos-0.05,decPos+0.05)
        seekWidgetsTo(20)
    }
});

var latLonsJSON={{object.latLonsJSON}}

{%if object.video %}
var params = { allowScriptAccess: "always" };
var atts = { id: "myytplayer" };
swfobject.embedSWF("http://www.youtube.com/v/tA1cMbcm6bc?enablejsapi=1&playerapiid=ytplayer&version=3",
                    "ytapiplayer", "425", "356", "8", null, null, params, atts);
{% endif %}

{%if object.flightvideo_set %}
//  This is the new way to deal with video, allowing multiple videos
    {% for video in flightvideo_set %}
    <video>
        <source src="/video/HHD00006.MOV">
    </video>
    {% endfor %}
{% endif %}

function seekWidgetsTo(seekTime) {
    seekVideoTo(seekTime)
    seekPlotTo(seekTime)
    seekTimelineTo(seekTime)
}

function seekPlotTo(seekTime) {
    //TODO very odd to use "battVltsData" for the name of the plot!
    plotCursor=battVltsData.plugins.canvasOverlay.get('plotCursor')
    plotCursor.options.x=seekTime
    battVltsData.plugins.canvasOverlay.draw(battVltsData)
}

function seekVideoTo(seekTime) {
    //TODO convert seekTime to seekSecs by subtracting video start time
    {%if object.video %}
    ytplayer = document.getElementById("myytplayer");
    ytplayer.seekTo(seekSecs);
    {% endif %}    
}

function seekTimelineTo(seekTime) {
    
    battVltsData
}

function onTimelineBarDragged() {
    seekWidgetsTo(timeline.customTime)
}

function initMap() {
    // Bing's Road imagerySet
    var broad = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Road"
    });
    // Bing's Aerial imagerySet
    var baerial = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Aerial"
    });
    // Bing's AerialWithLabels imagerySet
    var bhybrid = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "AerialWithLabels",
        name: "Bing Aerial With Labels",
        resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                      19567.87923828125, 9783.939619140625, 4891.9698095703125,
                      2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                      305.74811309814453, 152.87405654907226, 76.43702827453613,
                      38.218514137268066, 19.109257068634033, 9.554628534317017,
                      4.777314267158508, 2.388657133579254, 1.194328566789627,
                      0.5971642833948135, 0.25, 0.1, 0.05],
        serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                            19567.87923828125, 9783.939619140625,
                            4891.9698095703125, 2445.9849047851562,
                            1222.9924523925781, 611.4962261962891,
                            305.74811309814453, 152.87405654907226,
                            76.43702827453613, 38.218514137268066,
                            19.109257068634033, 9.554628534317017,
                            4.777314267158508, 2.388657133579254,
                            1.194328566789627, 0.5971642833948135],
        transitionEffect: 'resize'
    
    });


    flightMap = new OpenLayers.Map('map',{projection: new OpenLayers.Projection("EPSG:900913"),fractionalZoom: true});
    flightMap.addControl(new OpenLayers.Control.LayerSwitcher());
    flightMap.addControl(new OpenLayers.Control.ScaleLine());
    var flightPathFeaturesJSON = {
        "type": "FeatureCollection", 
        "features": [
        {
            "type": "Feature", 
            "geometry":
                {
                    "type": "LineString", 
                    "coordinates": latLonsJSON
                }, 
            
        },]
    };
    var geojson_format = new OpenLayers.Format.GeoJSON({
                    'internalProjection': new OpenLayers.Projection("EPSG:900913"),
                    'externalProjection': new OpenLayers.Projection("EPSG:4326")
                });
    vector_layer = new OpenLayers.Layer.Vector("Flight path",{ style:{strokeColor:"#FF0000",strokeWidth:1, projection: new OpenLayers.Projection("EPSG:4326")}, });
    limitedLayer = new OpenLayers.Layer.Vector("Selected flight path",{ style:{strokeColor:"#0000FF",strokeWidth:2, projection: new OpenLayers.Projection("EPSG:4326")}, });
    
    flightPathFeatures=geojson_format.read(flightPathFeaturesJSON);
    vector_layer.addFeatures(flightPathFeatures);
    flightMap.addLayers([bhybrid, baerial, broad, vector_layer,limitedLayer]);
    
    flightMap.zoomToExtent(vector_layer.getDataExtent());
    };

limitedFlightPath=function(start,end,origGeom,limitedLayer) {
    pathSubsetFeature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(origGeom.getVertices().slice(start,end)) )
    limitedLayer.removeAllFeatures()
    limitedLayer.addFeatures([pathSubsetFeature,])
    limitedLayer.redraw()
    return pathSubsetFeature
    };

limitedFlightPathDecimal=function(decStart,decEnd){
    totalPoints=vector_layer.features[0].geometry.getVertices().length
    start=totalPoints*decStart
    end=totalPoints*decEnd
    limitedFlightPath(start,end,vector_layer.features[0].geometry,limitedLayer)
    };

findBetween=function(startSecs,endSecs,timeList){
    timelist.filter()
    };



function drawTimeline() {
    //Drawing the timeline of all flights
    data = {{timeline_data|safe}}
    var options = {
        'width':  '100%',
        'height': '100%',
        'editable': false,
        'style': 'dot',
        'cluster': true,
        'showCustomTime':true
    };
    timeline = new links.Timeline(document.getElementById('timeline'))
    timeline.draw(data, options)
    timeline.setCustomTime(min)
    
    //Register an event to seek all widgets when the customtime bar is dragged
    links.events.addListener(timeline, 'timechange', onTimelineBarDragged)
};


initMap();
drawTimeline();


});
</script>

</head>
<body>
<div id="detailsContainer">
    <h1>Flight details</h1>
    {{object}}
    Mavlink messages by type
    <ul>
    {% for messageType in object.countMessagesByType %}
    <li>{{messageType.0}}: {{messageType.1}}</li>
    {% endfor %}
    </ul>
    Total mavlink messages: {{object.mavmessage_set.count}}

</div>
<div id="videoContainer">
    <h1>Video</h1>
    {% if object.video %}
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>    
    <div id="ytapiplayer"></div>
    <embed SRC="file://home/aaron/arducopter/afterflight/media/video/HHD00006.MOV"></embed>
    {% endif %}
</div>
<div id="plotContainer">
    <h1>Sensor data</h1>
        <div id="battVltsData" style="width:600px;height:300px"></div>    
</div>
<div id="mapContainer">
    <h1>Map</h1>
    <div id="map" style="width:600px;height:300px"></div>
</div>
<div id="timelineContainer">
    <div id="timeline">Timeline loading...</div>
</div>


</div>
</body>
</html>