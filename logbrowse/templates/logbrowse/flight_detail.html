<!DOCTYPE html>
<html>
<head>
<link type="text/css" href="http://dev.openlayers.org/addins/scalebar/trunk/theme/default/scalebar-thin.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="http://openlayers.org/dev/theme/default/style.css">
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}js/jqplot/jquery.jqplot.css" />
<script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script src="{{ STATIC_URL }}js/jquery.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.flot.js"></script>
<script src="{{ STATIC_URL }}js/jqplot/jquery.jqplot.min.js"></script>
<script src="{{ STATIC_URL }}js/jqplot/plugins/jqplot.dateAxisRenderer.js"></script>
<script src="{{ STATIC_URL }}js/jqplot/plugins/jqplot.cursor.min.js"></script>
<script src="http://openlayers.org/dev/OpenLayers.js"></script>
<script src="http://dev.openlayers.org/addins/scalebar/trunk/lib/OpenLayers/Control/ScaleBar.js"></script>
<script>
var flightMap, layer, vector_layer, battVltsData,battThrData, hoveredItem, features, flightPathFeatures, limitedLayer, limitedFlightPathDecimal, gpsTimestamps;

$(document).ready(function(){

gpsTimestamps={{object.gpsTimestamps}}
battThrData=[[{{object.battVltsDataFlot}}],[{{object.thrDataFlot}}]];
var apiKey = "An9cxmMkbbjVOwKKGr8hCIl6N6W30F7VChJdplng1Y12rOJIucGfYMoG5hk6lTct";
battVltsData = $.jqplot('battVltsData',  battThrData, 
    {
    title:'{{object}}',
    axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickInterval:60000},
         yaxis:{label:'Battery voltage, mV'}},
    series:[{showMarker:false}],
    zoom: true,
    cursor: {
        show: true,
        showVerticalLine: true,
        zoom: true,
        
    }
    }
 );
//Workaround for bug described at https://bitbucket.org/cleonello/jqplot/issue/633/jqplotdatahighlight-does-not-work-for-line
battVltsData.series[0].highlightMouseOver = true;

min=battThrData[0][0][0]
max=battThrData[0].slice(-1)[0][0]
$("#battVltsData").bind("jqplotDataMouseOver", function(event, srsInd, ptInd, data){
    if(data){
        hoveredItem=data
        decPos=(hoveredItem[0]-min)/(max-min)
        limitedFlightPathDecimal(decPos-0.05,decPos+0.05)
    }
});

var latLonsJSON={{object.latLonsJSON}}


function initMap() {
    // Bing's Road imagerySet
    var broad = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Road"
    });
    // Bing's Aerial imagerySet
    var baerial = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Aerial"
    });
    // Bing's AerialWithLabels imagerySet
    var bhybrid = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "AerialWithLabels",
        name: "Bing Aerial With Labels",
        resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                      19567.87923828125, 9783.939619140625, 4891.9698095703125,
                      2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                      305.74811309814453, 152.87405654907226, 76.43702827453613,
                      38.218514137268066, 19.109257068634033, 9.554628534317017,
                      4.777314267158508, 2.388657133579254, 1.194328566789627,
                      0.5971642833948135, 0.25, 0.1, 0.05],
        serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                            19567.87923828125, 9783.939619140625,
                            4891.9698095703125, 2445.9849047851562,
                            1222.9924523925781, 611.4962261962891,
                            305.74811309814453, 152.87405654907226,
                            76.43702827453613, 38.218514137268066,
                            19.109257068634033, 9.554628534317017,
                            4.777314267158508, 2.388657133579254,
                            1.194328566789627, 0.5971642833948135],
        transitionEffect: 'resize'
    
    });


    var gsat = new OpenLayers.Layer.Google(
        "Google Satellite",
        {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 20}
        // used to be {type: G_SATELLITE_MAP, numZoomLevels: 22}
    );
    var gphy = new OpenLayers.Layer.Google(
        "Google Physical",
        {type: google.maps.MapTypeId.TERRAIN}
        // used to be {type: G_PHYSICAL_MAP}
    );
    var gmap = new OpenLayers.Layer.Google(
        "Google Streets", // the default
        {numZoomLevels: 20}
        // default type, no change needed here
    );
    var ghyb = new OpenLayers.Layer.Google(
        "Google Hybrid",
        {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
        // used to be {type: G_HYBRID_MAP, numZoomLevels: 20}
    );

    flightMap = new OpenLayers.Map('map',{projection: new OpenLayers.Projection("EPSG:900913"),fractionalZoom: true});
    flightMap.addControl(new OpenLayers.Control.LayerSwitcher());
    flightMap.addControl(new OpenLayers.Control.ScaleLine());
    var flightPathFeaturesJSON = {
        "type": "FeatureCollection", 
        "features": [
        {
            "type": "Feature", 
            "geometry":
                {
                    "type": "LineString", 
                    "coordinates": latLonsJSON
                }, 
            
        },]
    };
    var geojson_format = new OpenLayers.Format.GeoJSON({
                    'internalProjection': new OpenLayers.Projection("EPSG:900913"),
                    'externalProjection': new OpenLayers.Projection("EPSG:4326")
                });
    vector_layer = new OpenLayers.Layer.Vector("Flight path",{ style:{strokeColor:"#FF0000",strokeWidth:1, projection: new OpenLayers.Projection("EPSG:4326")}, });
    limitedLayer = new OpenLayers.Layer.Vector("Selected flight path",{ style:{strokeColor:"#0000FF",strokeWidth:2, projection: new OpenLayers.Projection("EPSG:4326")}, });
    
    flightPathFeatures=geojson_format.read(flightPathFeaturesJSON);
    vector_layer.addFeatures(flightPathFeatures);
    flightMap.addLayers([baerial, broad, bhybrid, vector_layer,limitedLayer]);
    
    flightMap.zoomToExtent(vector_layer.getDataExtent());
    };

limitedFlightPath=function(start,end,origGeom,limitedLayer) {
    pathSubsetFeature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(origGeom.getVertices().slice(start,end)) )
    limitedLayer.removeAllFeatures()
    limitedLayer.addFeatures([pathSubsetFeature,])
    limitedLayer.redraw()
    return pathSubsetFeature
    };

limitedFlightPathDecimal=function(decStart,decEnd){
    totalPoints=vector_layer.features[0].geometry.getVertices().length
    start=totalPoints*decStart
    end=totalPoints*decEnd
    limitedFlightPath(start,end,vector_layer.features[0].geometry,limitedLayer)
    };

findBetween=function(startSecs,endSecs,timeList){
    timelist.filter()
    };

initMap();

});
</script>
</head>
<body>
{{object}}
Number of mavlink messages: {{object.mavmessage_set.count}}
<div id="battVltsData" style="width:600px;height:300px"></div>
<div id="map" style="width:600px;height:300px"></div>

</body>
</html>