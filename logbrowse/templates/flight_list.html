<!--
    Copyright 2013 Aaron Curtis

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html>
<head>
    <title>Volcanocopter flight list</title>
    <script type="text/javascript" src="/static/js/timeline.js"></script>
    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.scrollIntoView.min.js"></script>        
    <link rel="stylesheet" type="text/css" href="/static/css/flightList.css">
    <script src="/media/js/openlayers/OpenLayers.js"></script>
    <script type="text/javascript" src="/media/js/timeline.js"></script>
    <link rel="stylesheet" type="text/css" href="/media/css/timeline.css">
    <script src="/media/js/openlayers/lib/Control/ScaleBar.js"></script>
</head>

<body>




<div id="info">
<h1>Flight data overview</h1>

<table id="flights-table">
    <tr class="table-header">
        <th>Logfile</th>
        <th>Length</th>
        <th>Comments</th>
    </tr>
    <!-- To keep the table header floating above the table, we use position: fixed
    in the css. Then we need this blank table row -->
    <tr><td height="20px"></td></tr>

    {% for flight in object_list %}
        <tr>
            <td><a href=/flight/{{flight.slug}}>Log {{flight.id}} </a></td>
            <td>{% if flight.length %}{{flight.length}}{% endif %}</td>
            <td>{{flight.comments}}</td>
            <td>{{flight.gpsTimes.0}}</td>
        </tr>
    {% endfor %}
    </table>
</table>

</div>

<div id="allFlightsMap"></div>

<div id="allFlightsTimeline"></div>

    <script type="text/javascript">
        var timeline;
        var data;
        function drawTimeline() {
            //Drawing the timeline of all flights
            data = {{timeline_data|safe}}
            var options = {
                'editable': false,
                'style': 'box'
            };
            timeline = new links.Timeline(document.getElementById('allFlightsTimeline'));
            timeline.draw(data, options);
        };
        function highlightFlightInTable(event){
            flightsTableEntry=$("#flights-table>tbody>tr:contains(Log "+event.target.textContent+" )")
            flightsTableEntry.addClass('highlighted')
            flightsTableEntry.scrollIntoView(100)
        };
        function unHighlightFlightInTable(event){
            $("#flights-table>tbody>tr:contains(Log "+event.target.textContent+")").removeClass('highlighted')
        };
        function highlightFlightOnTL(event){
            //FIXTHIS. Should be some more direct connection between flights on the table and in the timeline.
            //Maybe draw the table from the timeline using JS.
            //Also, should only create selectors once, and then re-use them.
            event.stopPropagation();
            flightSeqNum=$("#flights-table>tbody>tr").index(event.currentTarget)
            timeline.items[flightSeqNum].select()
            return false;
        };
        function unHighlightFlightOnTL(event){
            event.stopPropagation();
            flightSeqNum=$("#flights-table>tbody>tr").index(event.currentTarget)
            timeline.items[flightSeqNum].unselect()
            return false;
        };
// Draw map of flight path
var WGS84 = new OpenLayers.Projection('EPSG:4326');
var MERCATOR = new OpenLayers.Projection('EPSG:900913');
var size = new OpenLayers.Size(21, 25);
var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
var apiKey = "An9cxmMkbbjVOwKKGr8hCIl6N6W30F7VChJdplng1Y12rOJIucGfYMoG5hk6lTct";
function initMap() {


    flightMap = new OpenLayers.Map('allFlightsMap',{projection: MERCATOR});
    flightMap.addControl(new OpenLayers.Control.LayerSwitcher());
    flightMap.addControl(new OpenLayers.Control.ScaleLine());
    var flightStartLocsJSON = {{flightStartLocs|safe}}
    var geojson_format = new OpenLayers.Format.GeoJSON({
                    'internalProjection': MERCATOR,
                    'externalProjection': WGS84
                });
    vector_layer = new OpenLayers.Layer.Vector("Flights",{
                styleMap: new OpenLayers.StyleMap({
                    "default": new OpenLayers.Style(OpenLayers.Util.applyDefaults({
                        graphicOpacity:1,
                        fontSize: "15px",
                        fontColor:"#00FF00",
                        fontWeight:"bold",
                        fill:false
                        }
                    , OpenLayers.Feature.Vector.style["default"])),
                    "selected": new OpenLayers.Style(OpenLayers.Util.applyDefaults({
                        label : "${name}",
                        labelAlign:"lb",
                        graphicOpacity:1,
                        fontColor:"#000000", 
                        fontWeight:"bold",                        
                        fill: true}
                        , OpenLayers.Feature.Vector.style["highlight"])),
                    "clicked": new OpenLayers.Style(OpenLayers.Util.applyDefaults({
                        label : "Opening in new window",
                        fontSize: "15px",
                        fontColor:"#000000",
                        fontWeight:"bold",                        
                        fill: true}
                        , OpenLayers.Feature.Vector.style["select"]))
                })})
    flightStartLocs=geojson_format.read(flightStartLocsJSON);
    // Bing's Road imagerySet
    var broad = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Road"
    });
    // Bing's Aerial imagerySet
    var baerial = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "Aerial"
    });
    // Bing's AerialWithLabels imagerySet
    var bhybrid = new OpenLayers.Layer.Bing({
        key: apiKey,
        type: "AerialWithLabels",
        name: "Bing Aerial With Labels",
        // Ugly custom resolutions are for allowing client zoom. May be a better way.
        resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                      19567.87923828125, 9783.939619140625, 4891.9698095703125,
                      2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                      305.74811309814453, 152.87405654907226, 76.43702827453613,
                      38.218514137268066, 19.109257068634033, 9.554628534317017,
                      4.777314267158508, 2.388657133579254, 1.194328566789627,
                      0.5971642833948135, 0.25, 0.1, 0.05],
        serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                            19567.87923828125, 9783.939619140625,
                            4891.9698095703125, 2445.9849047851562,
                            1222.9924523925781, 611.4962261962891,
                            305.74811309814453, 152.87405654907226,
                            76.43702827453613, 38.218514137268066,
                            19.109257068634033, 9.554628534317017,
                            4.777314267158508, 2.388657133579254,
                            1.194328566789627, 0.5971642833948135],
        transitionEffect: 'resize'
    });
    vector_layer.addFeatures(flightStartLocs);
    flightMap.addLayers([bhybrid, vector_layer]);
    flightMap.zoomToExtent(vector_layer.getDataExtent());

    // Adding hover and click events
    highlightCtrl = new OpenLayers.Control.SelectFeature(vector_layer, {
    hover: true,
    highlightOnly: true,
    renderIntent: "selected",
    });

    selectCtrl = new OpenLayers.Control.SelectFeature(
        vector_layer,
        {
            hover: false,
            clickout: true,
            multiple: false
        }
    );
    flightMap.addControl(highlightCtrl);
    highlightCtrl.activate();
    flightMap.addControl(selectCtrl);
    selectCtrl.activate();
    
    function flightSelected(evt){
        //window.open(evt.feature.attributes.slug,"Window1");
        //selectCtrl.unselectAll();
        // would be nice to use the highlightFlightInTable function here, but it takes the wrong kind of event...
        selectOnWidgets(evt.feature.attributes.number)
        return false;
    }
    vector_layer.events.register("featureselected", vector_layer, flightSelected);
};
    // Select all things that represent one log, given its ID
    function selectOnWidgets(flightLogId){
        unselectOnWidgets(flightLogId)
        //table
        flightsTableEntry=$("#flights-table>tbody>tr:contains(Log "+flightLogId+" )")
        flightsTableEntry.scrollIntoView(100)        
        flightsTableEntry.addClass('highlighted')  
        //timeline
        timeline.items[flightLogId].select()
        //map
        highlightCtrl.highlight(vector_layer.getFeaturesByAttribute("number",flightLogId))
    }
    // Unselect all things
    function unselectOnWidgets(flightLogId){
    //table
    $("#flights-table>tbody>tr").removeClass('highlighted')
    //timeline
    //map
    };

        $(document).ready(function() {
        initMap();
        drawTimeline();
        $(".timeline-event").hover(highlightFlightInTable,unHighlightFlightInTable)
        $("#flights-table>tbody>tr").hover(highlightFlightOnTL,unHighlightFlightOnTL)
        
        }
);    
    </script>
</body>
</html>
