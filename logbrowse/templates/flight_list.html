<!--
    Copyright 2013 Aaron Curtis

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html>
<head>
    <title>Volcanocopter flight list</title>
    <script type="text/javascript" src="/static/js/timeline.js"></script>
    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.scrollIntoView.min.js"></script>        
    <link rel="stylesheet" type="text/css" href="/static/css/flightList.css">
    <script src="/media/js/openlayers/OpenLayers.js"></script>
    <script type="text/javascript" src="/media/js/timeline.js"></script>
    <script src="/media/js/openlayers/lib/Control/ScaleBar.js"></script>
</head>

<body>




<div id="info">
<h1>Flight data overview</h1>

<table id="flights-table">
    <tr class="table-header">
        <th>Logfile</th>
        <th>Length</th>
        <th>Comments</th>
    </tr>
    <!-- To keep the table header floating above the table, we use position: fixed
    in the css. Then we need this blank table row -->
    <tr><td height="20px"></td></tr>

    {% for flight in object_list %}
        <tr>
            <td><a href=/flight/{{flight.slug}}>Log {{flight.id}} </a></td>
            <td>{% if flight.length %}{{flight.length}}{% endif %}</td>
            <td>{{flight.comments}}</td>
            <td>{{flight.gpsTimes.0}}</td>
        </tr>
    {% endfor %}
    </table>
</table>

</div>

<div id="allFlightsMap"></div>

<div id="allFlightsTimeline"></div>

    <script type="text/javascript">
        var timeline;
        var data;
        function drawTimeline() {
            //Drawing the timeline of all flights
            data = {{timeline_data|safe}}
            var options = {
                'editable': false,
                'style': 'box'
            };
            timeline = new links.Timeline(document.getElementById('allFlightsTimeline'));
            timeline.draw(data, options);
        };
        function highlightFlightInTable(event){
            flightsTableEntry=$("#flights-table>tbody>tr:contains(Log "+event.target.textContent+" )")
            flightsTableEntry.addClass('highlighted')
            flightsTableEntry.scrollIntoView(100)
        };
        function unHighlightFlightInTable(event){
            $("#flights-table>tbody>tr:contains(Log "+event.target.textContent+")").removeClass('highlighted')
        };
        function highlightFlightOnTL(event){
            //FIXTHIS. Should be some more direct connection between flights on the table and in the timeline.
            //Maybe draw the table from the timeline using JS.
            //Also, should only create selectors once, and then re-use them.
            event.stopPropagation();
            flightSeqNum=$("#flights-table>tbody>tr").index(event.currentTarget)
            timeline.items[flightSeqNum].select()
            return false;
        };
        function unHighlightFlightOnTL(event){
            event.stopPropagation();
            flightSeqNum=$("#flights-table>tbody>tr").index(event.currentTarget)
            timeline.items[flightSeqNum].unselect()
            return false;
        };
// Draw map of flight path
var WGS84 = new OpenLayers.Projection('EPSG:4326');
var MERCATOR = new OpenLayers.Projection('EPSG:900913');
var size = new OpenLayers.Size(21, 25);
var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
function initMap() {


    flightMap = new OpenLayers.Map('allFlightsMap');
    flightMap.addControl(new OpenLayers.Control.LayerSwitcher());
    flightMap.addControl(new OpenLayers.Control.ScaleLine());
    var flightStartLocsJSON = {
        "type": "FeatureCollection", 
        "features": [
        {
            "type": "Feature", 
            "geometry":
                {
                    "type": "MultiPoint", 
                    "coordinates": {{flightStartLocs}}
                }, 
            
        },]
    };
    var geojson_format = new OpenLayers.Format.GeoJSON();
    vector_layer = new OpenLayers.Layer.Vector("Flight path",{ style:{strokeColor:"#FF0000",strokeWidth:1, projection: WGS84}});
    flightStartLocs=geojson_format.read(flightStartLocsJSON);
    osm_layer=new OpenLayers.Layer.OSM();
    vector_layer.addFeatures(flightStartLocs);
    flightMap.addLayers([osm_layer, vector_layer]);
    flightMap.zoomToExtent(vector_layer.getDataExtent());
    };

        $(document).ready(function() {
        initMap();
        drawTimeline();
        $(".timeline-event").hover(highlightFlightInTable,unHighlightFlightInTable)
        $("#flights-table>tbody>tr").hover(highlightFlightOnTL,unHighlightFlightOnTL)
        
        
                
        }
);    
    </script>
</body>
</html>
